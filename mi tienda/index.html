<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaMariaDigital - Tienda de Productos Digitales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@700&family=Montserrat:wght@400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://checkout.bold.co/library/boldPaymentButton.js"></script>

    <style>
        /* Fuentes y Estilos */
        h1, h2, h3 { font-family: 'Poppins', sans-serif; }
        body, p, li { font-family: 'Montserrat', sans-serif; }
        
        body { background-color: #f8fafc; }
        
        /* Estilos Personalizados de la Tienda (simples) */
        .btn-primary { 
            background-color: #7c3aed;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 6px -1px rgba(124, 58, 237, 0.5);
        }
        .btn-primary:hover { background-color: #6d28d9; transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(1px); }

        .btn-secondary { background-color: #facc15; color: #1f2937; transition: background-color 0.3s ease, transform 0.1s ease; }
        .btn-secondary:hover { background-color: #eab308; transform: translateY(-1px); }
        .btn-secondary:active { transform: translateY(1px); }

        .carousel-track { display: flex; transition: transform 0.8s ease-in-out; }
        .carousel-item { min-width: 100%; flex-shrink: 0; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.hidden { opacity: 0; visibility: hidden; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex-grow">

        <header class="flex justify-between items-center mb-8 p-4 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <span class="text-purple-600 mr-2">ðŸš€</span> LaMariaDigital
            </h1>
            <button onclick="toggleCartModal()" class="relative btn-primary text-white font-semibold py-2 px-4 rounded-lg flex items-center">
                <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i>
                Carrito (<span id="cart-count">0</span>)
            </button>
        </header>

        <section class="mb-12 bg-white p-6 shadow-xl rounded-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ðŸŒŸ Productos Destacados</h2>
            <div class="relative overflow-hidden rounded-lg shadow-inner">
                <div id="carousel-track" class="carousel-track">
                </div>
                <div id="carousel-dots" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
                </div>
            </div>
        </section>

        <section class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Todo el Universo Digital</h2>
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>
        </section>

        <div id="cart-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden">
            <div class="fixed inset-0 overflow-y-auto">
                <div class="flex items-start justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true" onclick="toggleCartModal()">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">â€‹</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all my-8 sm:align-middle sm:max-w-lg sm:w-full" role="dialog" aria-modal="true" aria-labelledby="modal-headline">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-xl font-bold leading-6 text-gray-900 mb-4 border-b pb-2">Tu Carrito Digital</h3>
                            <div id="cart-items-container" class="space-y-4 max-h-60 overflow-y-auto">
                            </div>
                            <div class="mt-4 pt-4 border-t">
                                <p class="text-lg font-semibold flex justify-between">
                                    Total: <span id="cart-total">$0.00 USD</span>
                                </p>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button onclick="initiatePayment()" type="button" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white sm:ml-3 sm:w-auto sm:text-sm btn-primary">
                                Pagar con Bold Checkout
                            </button>
                            <button onclick="toggleCartModal()" type="button" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Seguir Comprando
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="added-modal" class="modal fixed inset-0 flex items-center justify-center z-[100] hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl transform transition-transform duration-300 scale-100">
                <div class="flex items-center">
                    <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mr-3"></i>
                    <div>
                        <p class="text-xl font-semibold text-gray-800">Â¡Producto AÃ±adido!</p>
                        <p class="text-gray-500 text-sm mt-1">Tu artÃ­culo estÃ¡ esperando en el carrito.</p>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button onclick="hideAddedModal()" class="text-gray-600 hover:text-gray-900 text-sm">Cerrar</button>
                    <button onclick="toggleCartModal(); hideAddedModal();" class="text-purple-600 font-medium hover:text-purple-800 text-sm">Ver Carrito</button>
                </div>
            </div>
        </div>

        <div id="error-message" class="fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl shadow-lg z-50 hidden" role="alert">
            <p class="font-bold">Error de IntegraciÃ³n</p>
            <p class="text-sm" id="error-text">Mensaje de error.</p>
        </div>


    </div> <footer class="bg-gray-200 text-gray-600 mt-12 py-4 text-center text-sm border-t border-gray-300">
        <p>Â© 2025 Â· LaMariaDigital | Todos los Derechos Reservados</p>
    </footer>

    <script>
        // Inicializar iconos de Lucide
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadCartFromStorage();
            renderProductList();
            startCarousel();
        });


        // --- 1. CONFIGURACIÃ“N INICIAL Y PRODUCTOS ---
        
        // LLAVE DE IDENTIDAD DE PRUEBAS (Sandbox)
        const BOLD_API_KEY = "231_Y3kXs2x-XeDm3DcK0X_TcfyNSHfDyYykgodWQ7A"; 
        
        // URL de tu Edge Function de Supabase (Correcta)
        const SUPABASE_FUNCTION_URL = "https://xdazqrcwxwbgklkecyjo.supabase.co/functions/v1/bold-checkout";
        
        // URL de Ã©xito (DiagnÃ³stico para evitar errores)
        const BOLD_REDIRECTION_URL = "https://www.google.com"; 

        const CURRENCY = "USD";
        const LOCALE_OPTIONS = { style: 'currency', currency: CURRENCY };
        const PRODUCT_IMAGE_PLACEHOLDER = "https://placehold.co/400x300/f0f9ff/003c94?text=Producto+Digital";


        // Productos Digitales Fijos para LaMariaDigital (solo dos)
        const PRODUCTS = [
            { id: 1, name: "Ebook Interactivo Con Agente de IA", price: 15.00, description: "CÃ³mo evitar que PayPal congele tu dinero por 21 dÃ­as. Aprende mientras interactÃºas con un agente experto.", image: "https://placehold.co/400x300/f8e71c/1f2937?text=Ebook+%2B+IA" },
            { id: 2, name: "Academia de Marketing Digital con MRR", price: 37.00, description: "Acceso con Derechos de Reventa (Master Resell Rights) . Contenido de Marketing Digital en espaÃ±ol.", image: "https://placehold.co/400x300/7c3aed/ffffff?text=Academia+MRR" }
        ];

        let cart = [];


        // --- 2. FUNCIONES DE CARRO Y PERSISTENCIA ---

        function saveCartToStorage() {
            try {
                localStorage.setItem('lamariadigital_cart', JSON.stringify(cart));
            } catch (e) {
                console.error("Error al guardar el carrito en localStorage:", e);
            }
        }

        function loadCartFromStorage() {
            try {
                const storedCart = localStorage.getItem('lamariadigital_cart');
                if (storedCart) {
                    cart = JSON.parse(storedCart);
                }
            } catch (e) {
                console.error("Error al cargar el carrito de localStorage:", e);
                cart = [];
            }
        }

        function calculateCartTotal() {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }

        function updateCartUI() {
            const total = calculateCartTotal();
            document.getElementById('cart-count').textContent = cart.reduce((count, item) => count + item.quantity, 0);
            document.getElementById('cart-total').textContent = total.toLocaleString('es-CO', LOCALE_OPTIONS);
            renderCartItems();
        }

        function addToCart(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }

            saveCartToStorage();
            updateCartUI();
            showAddedModal();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveCartToStorage();
            updateCartUI();
        }
        
        function decrementQuantity(productId) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                if (item.quantity > 1) {
                    item.quantity -= 1;
                } else {
                    removeFromCart(productId);
                }
                saveCartToStorage();
                updateCartUI();
            }
        }


        // --- 3. RENDERING (HTML GENERATION) ---

        function renderProductCard(product) {
            return `
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col h-full hover:shadow-xl transition-shadow duration-300">
                    <img src="${product.image || PRODUCT_IMAGE_PLACEHOLDER}" alt="${product.name}" class="w-full h-40 object-cover rounded-lg mb-4 border border-gray-100">
                    <h3 class="text-xl font-bold text-purple-600 mb-2">${product.name}</h3>
                    <p class="text-gray-500 text-sm mb-4 flex-grow">${product.description}</p>
                    <div class="flex justify-between items-center mt-auto pt-4 border-t">
                        <span class="text-2xl font-extrabold text-gray-800">${product.price.toLocaleString('es-CO', LOCALE_OPTIONS)}</span>
                        <button onclick="addToCart(${product.id})" class="btn-secondary text-sm font-semibold py-2 px-4 rounded-full shadow-md hover:shadow-lg">
                            <i data-lucide="plus" class="w-4 h-4 inline-block mr-1"></i>
                            AÃ±adir
                        </button>
                    </div>
                </div>
            `;
        }

        function renderProductList() {
            const container = document.getElementById('product-list');
            const carouselTrack = document.getElementById('carousel-track');
            const carouselDots = document.getElementById('carousel-dots');

            container.innerHTML = PRODUCTS.map(renderProductCard).join('');
            
            // Renderizar el carrusel
            carouselTrack.innerHTML = PRODUCTS.map((product, index) => `
                <div class="carousel-item p-6 md:p-10 bg-gradient-to-r from-purple-50 to-indigo-50 flex flex-col md:flex-row items-center rounded-lg shadow-inner">
                    <div class="md:w-1/2 p-4 order-2 md:order-1">
                        <span class="text-xs font-semibold text-white bg-purple-500 py-1 px-3 rounded-full uppercase tracking-wider mb-2 inline-block">Â¡Nuevo!</span>
                        <h3 class="text-3xl font-extrabold text-gray-800 mb-3">${product.name}</h3>
                        <p class="text-gray-600 mb-6">${product.description}</p>
                        <div class="flex items-center space-x-4">
                            <span class="text-3xl font-black text-purple-700">${product.price.toLocaleString('es-CO', LOCALE_OPTIONS)}</span>
                            <button onclick="addToCart(${product.id})" class="btn-primary text-white font-semibold py-3 px-6 rounded-full shadow-xl">
                                Acceder Ahora <i data-lucide="arrow-right" class="w-5 h-5 inline-block ml-1"></i>
                            </button>
                        </div>
                    </div>
                    <div class="md:w-1/2 flex justify-center order-1 md:order-2 mb-6 md:mb-0">
                        <img src="${product.image || PRODUCT_IMAGE_PLACEHOLDER}" alt="${product.name}" class="w-full max-w-xs h-auto rounded-xl shadow-2xl border-4 border-white transform hover:scale-[1.02] transition-transform duration-300">
                    </div>
                </div>
            `).join('');

            // Renderizar puntos del carrusel
            carouselDots.innerHTML = PRODUCTS.map((_, index) => `
                <button onclick="goToSlide(${index})" class="w-3 h-3 rounded-full bg-white opacity-50 hover:opacity-100 transition-opacity duration-300" data-slide-index="${index}"></button>
            `).join('');

            lucide.createIcons();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">Tu carrito estÃ¡ vacÃ­o. Â¡AÃ±ade un producto!</p>';
                return;
            }

            container.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center border-b pb-2">
                    <div class="flex items-center space-x-3">
                        <img src="${item.image || PRODUCT_IMAGE_PLACEHOLDER}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md">
                        <div>
                            <p class="text-sm font-semibold text-gray-800">${item.name}</p>
                            <p class="text-xs text-gray-500">${item.price.toLocaleString('es-CO', LOCALE_OPTIONS)} c/u</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="decrementQuantity(${item.id})" class="text-gray-500 hover:text-red-500 text-lg p-1 rounded-full border border-gray-300 w-6 h-6 flex items-center justify-center">
                            <i data-lucide="minus" class="w-3 h-3"></i>
                        </button>
                        <span class="text-sm font-medium">${item.quantity}</span>
                         <button onclick="addToCart(${item.id})" class="text-gray-500 hover:text-green-500 text-lg p-1 rounded-full border border-gray-300 w-6 h-6 flex items-center justify-center">
                            <i data-lucide="plus" class="w-3 h-3"></i>
                        </button>
                        <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700 p-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons(); 
        }


        // --- 4. LÃ“GICA DEL CARRUSEL ---

        let currentSlide = 0;
        let slideInterval;

        function startCarousel() {
            if (PRODUCTS.length > 0) {
                slideInterval = setInterval(nextSlide, 4000); 
                updateCarouselUI();
            }
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % PRODUCTS.length;
            updateCarouselUI();
        }

        function goToSlide(index) {
            clearInterval(slideInterval);
            currentSlide = index;
            updateCarouselUI();
            startCarousel(); 
        }

        function updateCarouselUI() {
            const track = document.getElementById('carousel-track');
            const dots = document.querySelectorAll('#carousel-dots button');
            if (track) {
                const offset = currentSlide * -100;
                track.style.transform = `translateX(${offset}%)`;

                dots.forEach((dot, index) => {
                    dot.classList.remove('opacity-100', 'bg-purple-600');
                    dot.classList.add('opacity-50', 'bg-white');
                    if (index === currentSlide) {
                        dot.classList.add('opacity-100', 'bg-purple-600');
                    }
                });
            }
        }


        // --- 5. LÃ“GICA DE MODALES ---

        function toggleCartModal() {
            const modal = document.getElementById('cart-modal');
            modal.classList.toggle('hidden');
        }
        
        function showAddedModal() {
            const modal = document.getElementById('added-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 3000); 
        }

        function hideAddedModal() {
            document.getElementById('added-modal').classList.add('hidden');
        }

        function showErrorMessage(message) {
            const errorDiv = document.getElementById('error-message');
            document.getElementById('error-text').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // --- 6. FUNCIÃ“N DE PAGO SEGURA (CON SUPABASE BACKEND) ---

        async function initiatePayment() {
            if (cart.length === 0) {
                showErrorMessage("El carrito estÃ¡ vacÃ­o. Por favor, aÃ±ade productos antes de pagar.");
                return;
            }

            const totalAmountCents = Math.round(calculateCartTotal() * 100); 
            const orderId = `ORD-LMD-${Date.now()}-${Math.floor(Math.random() * 9999)}`;
            
            const lineItems = cart.map(item => ({
                id: item.id,
                name: item.name,
                unit_price: Math.round(item.price * 100),
                quantity: item.quantity
            }));
            
            const payload = {
                orderId: orderId,
                amount: totalAmountCents,
                currency: CURRENCY,
                apiKey: BOLD_API_KEY,
                redirectionUrl: BOLD_REDIRECTION_URL,
                lineItems: lineItems
            };

            showErrorMessage("Conectando con el servidor seguro de Bold...");
            document.getElementById('error-message').classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
            document.getElementById('error-message').classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');


            try {
                const response = await fetch(SUPABASE_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.redirectUrl) {
                    toggleCartModal();
                    document.getElementById('error-message').classList.add('hidden');
                    window.location.href = data.redirectUrl;

                    cart = [];
                    saveCartToStorage();
                    updateCartUI();
                } else {
                    showErrorMessage(`Error de seguridad: ${data.message || 'No se pudo generar el hash de integridad.'}`);
                    document.getElementById('error-message').classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700');
                    document.getElementById('error-message').classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                }

            } catch (error) {
                console.error("Error de conexiÃ³n con Supabase:", error);
                showErrorMessage("Error de conexiÃ³n: Verifica que tu funciÃ³n de Supabase estÃ© desplegada correctamente.");
                document.getElementById('error-message').classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700');
                document.getElementById('error-message').classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            }
        }
    </script>
</body>
</html>